version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "ðŸ“¦ Instalando pnpm..."
      - npm install -g pnpm
      - pnpm config set store-dir /root/.pnpm-store
      - echo "ðŸ“¦ Instalando jq para procesar JSON..."
      - apt-get update -y && apt-get install -y jq
      - echo "ðŸ“¦ Instalando dependencias del monorepo..."
      - pnpm install --frozen-lockfile
      
  build:
    commands:
      # 1. DESPLEGAR INFRAESTRUCTURA
      - echo "ðŸš€ Desplegando infraestructura con CDK..."
      - pnpm --filter @sevens/cdk-core exec cdk deploy CoreStack --require-approval never --outputs-file cdk-outputs.json
      
      # 2. MIGRAR BASE DE DATOS
      - echo "âš™ï¸ Iniciando migraciÃ³n de base de datos..."
      - export DB_SECRET_ARN=$(jq -r '.CoreStack.DbSecretArn' cdk-outputs.json)
      - export DATABASE_HOST=$(jq -r '.CoreStack.RdsProxyEndpoint' cdk-outputs.json)
      - echo "   -> Obteniendo credenciales de la base de datos..."
      - export DB_SECRET=$(aws secretsmanager get-secret-value --secret-id $DB_SECRET_ARN --query SecretString --output text)
      - export DB_USER=$(echo $DB_SECRET | jq -r .username)
      - export DB_PASS=$(echo $DB_SECRET | jq -r .password)
      - export DATABASE_URL="postgresql://$DB_USER:$DB_PASS@$DATABASE_HOST:5432/postgres"
      - echo "   -> Ejecutando Prisma Migrate..."
      - npx prisma migrate deploy --schema packages/db/prisma/schema.prisma

      # 3. PUBLICAR FRONTEND
      - echo "ðŸŽ¨ Iniciando publicaciÃ³n del frontend..."
      - export FRONTEND_BUCKET=$(jq -r '.CoreStack.FrontendBucketName' cdk-outputs.json)
      - export VITE_API_BASE=$(jq -r '.CoreStack.ApiUrl' cdk-outputs.json)
      - echo "   -> Compilando aplicaciÃ³n frontend..."
      - pnpm run build
      - echo "   -> Sincronizando archivos con S3..."
      - aws s3 sync dist s3://$FRONTEND_BUCKET/ --delete

cache:
  paths:
    - '/root/.pnpm-store'